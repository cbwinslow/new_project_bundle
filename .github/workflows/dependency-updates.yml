# Dependency Update Automation
# Automatically handles dependency updates from Dependabot

name: Dependency Updates

on:
  pull_request:
    types: [opened, synchronize]
    paths:
      - 'package.json'
      - 'package-lock.json'
      - 'yarn.lock'
      - 'pnpm-lock.yaml'
      - 'requirements.txt'
      - 'Pipfile.lock'
      - 'poetry.lock'
      - 'go.mod'
      - 'go.sum'
      - 'Cargo.lock'
      - 'Gemfile.lock'
      - 'composer.lock'

permissions:
  contents: write
  pull-requests: write

jobs:
  # Auto-merge patch updates from Dependabot
  auto-merge:
    name: Auto-merge Dependencies
    runs-on: ubuntu-latest
    if: github.actor == 'dependabot[bot]'
    steps:
      - name: Dependabot metadata
        id: metadata
        uses: dependabot/fetch-metadata@v2
        with:
          github-token: "${{ secrets.GITHUB_TOKEN }}"

      - name: Enable auto-merge for patch updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch'
        run: gh pr merge --auto --squash "$PR_URL"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Label patch updates
        if: steps.metadata.outputs.update-type == 'version-update:semver-patch'
        run: gh pr edit "$PR_URL" --add-label "auto-merge"
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Flag major updates for review
        if: steps.metadata.outputs.update-type == 'version-update:semver-major'
        run: |
          gh pr edit "$PR_URL" --add-label "major-update,needs-review"
          gh pr comment "$PR_URL" --body "⚠️ This is a **major version update**. Please review the changelog and ensure there are no breaking changes."
        env:
          PR_URL: ${{ github.event.pull_request.html_url }}
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

  # Check for known vulnerabilities in updated dependencies
  vulnerability-check:
    name: Vulnerability Check
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci --ignore-scripts
        continue-on-error: true

      - name: Run audit
        run: |
          npm audit --audit-level=high --json > audit-results.json || true
          
          # Check if there are high/critical vulnerabilities
          if [ -f audit-results.json ]; then
            HIGH_COUNT=$(jq '.metadata.vulnerabilities.high // 0' audit-results.json)
            CRITICAL_COUNT=$(jq '.metadata.vulnerabilities.critical // 0' audit-results.json)
            
            if [ "$HIGH_COUNT" -gt 0 ] || [ "$CRITICAL_COUNT" -gt 0 ]; then
              echo "⚠️ Found $HIGH_COUNT high and $CRITICAL_COUNT critical vulnerabilities"
              exit 1
            fi
          fi
        continue-on-error: true

  # Generate dependency report
  dependency-report:
    name: Dependency Report
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Install dependencies
        run: npm ci --ignore-scripts
        continue-on-error: true

      - name: Generate outdated report
        run: |
          echo "## Dependency Status" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          (npm outdated || true) >> $GITHUB_STEP_SUMMARY
          echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
        continue-on-error: true

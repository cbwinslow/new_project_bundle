# AI Code Review Configuration
# Configures AI reviewers like Codex, OpenHands, and Gemini

name: AI Review

on:
  pull_request:
    types: [opened, synchronize, reopened]

permissions:
  contents: read
  pull-requests: write

jobs:
  # GitHub Copilot is automatically available for code suggestions
  # This job documents how to integrate various AI reviewers

  ai-review-info:
    name: AI Review Setup
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - name: AI Review Information
        run: |
          echo "## AI Code Review Configuration" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "This repository is configured to use the following AI reviewers:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### GitHub Copilot" >> $GITHUB_STEP_SUMMARY
          echo "- **Status**: Built-in (if enabled for the repository)" >> $GITHUB_STEP_SUMMARY
          echo "- **Features**: Code suggestions, PR summaries, code review comments" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### OpenHands (formerly OpenDevin)" >> $GITHUB_STEP_SUMMARY
          echo "- **Setup**: Install from GitHub Marketplace" >> $GITHUB_STEP_SUMMARY
          echo "- **Documentation**: https://github.com/All-Hands-AI/OpenHands" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### Google Gemini Code Assist" >> $GITHUB_STEP_SUMMARY
          echo "- **Setup**: Configure via Google Cloud" >> $GITHUB_STEP_SUMMARY
          echo "- **Documentation**: https://cloud.google.com/gemini/docs/codeassist" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "### CodeRabbit" >> $GITHUB_STEP_SUMMARY
          echo "- **Setup**: Install from GitHub Marketplace" >> $GITHUB_STEP_SUMMARY
          echo "- **Documentation**: https://coderabbit.ai" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY

  # Example: OpenAI-based review (if you have API access)
  openai-review:
    name: OpenAI Review
    runs-on: ubuntu-latest
    if: false  # Disabled by default - enable and configure secrets
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Get PR diff
        id: diff
        run: |
          git diff origin/${{ github.base_ref }}...HEAD > pr_diff.txt
          echo "Diff generated"

      - name: AI Code Review
        uses: actions/github-script@v7
        env:
          OPENAI_API_KEY: ${{ secrets.OPENAI_API_KEY }}
        with:
          script: |
            // This is a placeholder for OpenAI-based code review
            // You would need to implement the actual API call
            console.log('OpenAI review would run here with proper API configuration');
            
            // Example comment structure:
            // await github.rest.pulls.createReview({
            //   owner: context.repo.owner,
            //   repo: context.repo.repo,
            //   pull_number: context.payload.pull_request.number,
            //   body: 'AI Review Summary...',
            //   event: 'COMMENT'
            // });

  # PR Analysis
  pr-analysis:
    name: PR Analysis
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Analyze PR
        uses: actions/github-script@v7
        with:
          script: |
            const pr = context.payload.pull_request;
            
            // Analyze the PR
            const { data: files } = await github.rest.pulls.listFiles({
              owner: context.repo.owner,
              repo: context.repo.repo,
              pull_number: pr.number
            });
            
            // Categorize changes
            const stats = {
              additions: 0,
              deletions: 0,
              fileTypes: {},
              complexity: 'low'
            };
            
            for (const file of files) {
              stats.additions += file.additions;
              stats.deletions += file.deletions;
              
              const ext = file.filename.split('.').pop() || 'unknown';
              stats.fileTypes[ext] = (stats.fileTypes[ext] || 0) + 1;
            }
            
            // Determine complexity
            const totalChanges = stats.additions + stats.deletions;
            if (totalChanges > 500) {
              stats.complexity = 'high';
            } else if (totalChanges > 100) {
              stats.complexity = 'medium';
            }
            
            // Generate summary
            const summary = `## PR Analysis Summary
            
            üìä **Statistics:**
            - Lines added: +${stats.additions}
            - Lines removed: -${stats.deletions}
            - Files changed: ${files.length}
            - Complexity: ${stats.complexity}
            
            üìÅ **File Types:**
            ${Object.entries(stats.fileTypes).map(([ext, count]) => `- .${ext}: ${count} file(s)`).join('\n')}
            
            ${stats.complexity === 'high' ? '‚ö†Ô∏è **Note:** This is a large PR. Consider breaking it into smaller PRs for easier review.' : ''}
            `;
            
            // Post as comment
            await github.rest.issues.createComment({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: pr.number,
              body: summary
            });

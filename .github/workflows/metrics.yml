# Metrics and analytics workflow
# Generates repository metrics and insights

name: Repository Metrics

on:
  schedule:
    - cron: '0 0 1 * *'  # Monthly on the 1st
  workflow_dispatch:

permissions:
  contents: read
  issues: read
  pull-requests: read

jobs:
  generate-metrics:
    name: Generate Metrics
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v6

      - name: Generate repository metrics
        uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            
            // Get repository info
            const repoInfo = await github.rest.repos.get({ owner, repo });
            
            // Get contributors
            const contributors = await github.rest.repos.listContributors({
              owner,
              repo,
              per_page: 100
            });
            
            // Get recent issues
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            const issues = await github.rest.issues.listForRepo({
              owner,
              repo,
              state: 'all',
              since: thirtyDaysAgo.toISOString(),
              per_page: 100
            });
            
            const openIssues = issues.data.filter(i => !i.pull_request && i.state === 'open');
            const closedIssues = issues.data.filter(i => !i.pull_request && i.state === 'closed');
            const openPRs = issues.data.filter(i => i.pull_request && i.state === 'open');
            const mergedPRs = issues.data.filter(i => i.pull_request && i.state === 'closed');
            
            // Get releases
            const releases = await github.rest.repos.listReleases({
              owner,
              repo,
              per_page: 10
            });
            
            // Generate summary
            let summary = `# Repository Metrics Report\n\n`;
            summary += `**Generated:** ${new Date().toISOString()}\n\n`;
            
            summary += `## Overview\n\n`;
            summary += `| Metric | Value |\n`;
            summary += `|--------|-------|\n`;
            summary += `| Stars | ${repoInfo.data.stargazers_count} |\n`;
            summary += `| Forks | ${repoInfo.data.forks_count} |\n`;
            summary += `| Watchers | ${repoInfo.data.subscribers_count} |\n`;
            summary += `| Open Issues | ${repoInfo.data.open_issues_count} |\n`;
            summary += `| Contributors | ${contributors.data.length} |\n`;
            summary += `| Size | ${(repoInfo.data.size / 1024).toFixed(2)} MB |\n\n`;
            
            summary += `## Last 30 Days Activity\n\n`;
            summary += `| Metric | Count |\n`;
            summary += `|--------|-------|\n`;
            summary += `| New Issues | ${openIssues.length + closedIssues.length} |\n`;
            summary += `| Closed Issues | ${closedIssues.length} |\n`;
            summary += `| Open PRs | ${openPRs.length} |\n`;
            summary += `| Merged PRs | ${mergedPRs.length} |\n\n`;
            
            summary += `## Top Contributors\n\n`;
            summary += `| Contributor | Contributions |\n`;
            summary += `|-------------|---------------|\n`;
            for (const contributor of contributors.data.slice(0, 10)) {
              summary += `| @${contributor.login} | ${contributor.contributions} |\n`;
            }
            summary += `\n`;
            
            summary += `## Recent Releases\n\n`;
            for (const release of releases.data.slice(0, 5)) {
              summary += `- **${release.tag_name}** - ${new Date(release.published_at).toLocaleDateString()}\n`;
            }
            
            console.log(summary);
            core.summary.addRaw(summary);
            await core.summary.write();

      - name: Upload metrics
        uses: actions/upload-artifact@v6
        with:
          name: repository-metrics
          path: |
            ${{ github.workspace }}/*.md
          retention-days: 90

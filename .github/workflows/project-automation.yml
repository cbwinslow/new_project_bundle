# Project Items Automation
# Syncs issues and PRs with GitHub Projects

name: Project Automation

on:
  issues:
    types: [opened, closed, reopened, labeled, unlabeled, assigned]
  pull_request:
    types: [opened, closed, reopened, ready_for_review, converted_to_draft]

permissions:
  contents: read
  issues: write
  pull-requests: write

jobs:
  # Add new issues to project
  add-to-project:
    name: Add to Project Board
    runs-on: ubuntu-latest
    if: github.event.action == 'opened'
    steps:
      - uses: actions/github-script@v8
        with:
          script: |
            // This script requires a project number and project token
            // You can customize this to work with your GitHub Project
            
            const item = context.payload.issue || context.payload.pull_request;
            const isIssue = context.payload.issue !== undefined;
            
            console.log(`Adding ${isIssue ? 'issue' : 'PR'} #${item.number} to project board...`);
            
            // Add labels based on type
            const labels = [];
            
            if (isIssue) {
              labels.push('in-backlog');
            } else {
              labels.push('in-review');
            }
            
            if (labels.length > 0) {
              await github.rest.issues.addLabels({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: item.number,
                labels: labels
              });
            }

  # Update project status based on labels
  update-status:
    name: Update Project Status
    runs-on: ubuntu-latest
    if: github.event.action == 'labeled' || github.event.action == 'unlabeled'
    steps:
      - uses: actions/github-script@v8
        with:
          script: |
            const issue = context.payload.issue;
            const label = context.payload.label;
            
            // Define status transitions based on labels
            const statusLabels = {
              'in-progress': 'In Progress',
              'in-review': 'In Review',
              'blocked': 'Blocked',
              'done': 'Done'
            };
            
            if (label && statusLabels[label.name]) {
              console.log(`Issue #${issue.number} status changed to: ${statusLabels[label.name]}`);
              
              // Remove other status labels
              for (const statusLabel of Object.keys(statusLabels)) {
                if (statusLabel !== label.name) {
                  await github.rest.issues.removeLabel({
                    owner: context.repo.owner,
                    repo: context.repo.repo,
                    issue_number: issue.number,
                    name: statusLabel
                  }).catch(() => {});
                }
              }
            }

  # Auto-close issues when PR is merged
  close-linked-issues:
    name: Close Linked Issues
    runs-on: ubuntu-latest
    if: github.event.action == 'closed' && github.event.pull_request.merged == true
    steps:
      - uses: actions/github-script@v8
        with:
          script: |
            const pr = context.payload.pull_request;
            const body = pr.body || '';
            
            // Find linked issues
            const issuePattern = /(close[sd]?|fix(e[sd])?|resolve[sd]?)\s*#(\d+)/gi;
            let match;
            const linkedIssues = [];
            
            while ((match = issuePattern.exec(body)) !== null) {
              linkedIssues.push(parseInt(match[3]));
            }
            
            for (const issueNumber of linkedIssues) {
              try {
                // Add completion comment
                await github.rest.issues.createComment({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  body: `ðŸŽ‰ This issue was addressed in PR #${pr.number} by @${pr.user.login}`
                });
                
                // Update labels
                await github.rest.issues.addLabels({
                  owner: context.repo.owner,
                  repo: context.repo.repo,
                  issue_number: issueNumber,
                  labels: ['done']
                });
                
                console.log(`Processed linked issue #${issueNumber}`);
              } catch (error) {
                console.log(`Could not process issue #${issueNumber}: ${error.message}`);
              }
            }

  # Move to done when closed
  move-to-done:
    name: Move to Done
    runs-on: ubuntu-latest
    if: github.event.action == 'closed'
    steps:
      - uses: actions/github-script@v8
        with:
          script: |
            const item = context.payload.issue || context.payload.pull_request;
            const isIssue = context.payload.issue !== undefined;
            const isPR = context.payload.pull_request !== undefined;
            
            // Determine completion label
            let completionLabel = 'done';
            
            if (isPR) {
              completionLabel = context.payload.pull_request.merged ? 'merged' : 'closed';
            }
            
            if (isIssue && context.payload.issue.state_reason === 'not_planned') {
              completionLabel = 'wont-fix';
            }
            
            // Remove in-progress type labels
            const labelsToRemove = ['in-progress', 'in-review', 'in-backlog', 'needs-triage'];
            
            for (const label of labelsToRemove) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: item.number,
                name: label
              }).catch(() => {});
            }
            
            // Add completion label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: item.number,
              labels: [completionLabel]
            });
            
            console.log(`${isIssue ? 'Issue' : 'PR'} #${item.number} marked as ${completionLabel}`);

  # Move back to backlog when reopened
  move-to-backlog:
    name: Move to Backlog
    runs-on: ubuntu-latest
    if: github.event.action == 'reopened'
    steps:
      - uses: actions/github-script@v8
        with:
          script: |
            const item = context.payload.issue || context.payload.pull_request;
            
            // Remove completion labels
            const labelsToRemove = ['done', 'merged', 'closed', 'wont-fix'];
            
            for (const label of labelsToRemove) {
              await github.rest.issues.removeLabel({
                owner: context.repo.owner,
                repo: context.repo.repo,
                issue_number: item.number,
                name: label
              }).catch(() => {});
            }
            
            // Add backlog label
            await github.rest.issues.addLabels({
              owner: context.repo.owner,
              repo: context.repo.repo,
              issue_number: item.number,
              labels: ['in-backlog']
            });
            
            console.log(`Item #${item.number} moved back to backlog`);

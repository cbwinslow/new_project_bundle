# Scheduled maintenance workflow
# Runs periodic tasks to keep the repository healthy

name: Scheduled Maintenance

on:
  schedule:
    - cron: '0 3 * * 0'  # Every Sunday at 3 AM UTC
  workflow_dispatch:
    inputs:
      task:
        description: 'Maintenance task to run'
        required: true
        type: choice
        options:
          - all
          - cache-cleanup
          - artifact-cleanup
          - branch-cleanup
          - dependency-check

permissions:
  contents: write
  actions: write

jobs:
  # Clean up old caches
  cache-cleanup:
    name: Cache Cleanup
    runs-on: ubuntu-latest
    if: github.event.inputs.task == 'all' || github.event.inputs.task == 'cache-cleanup' || github.event_name == 'schedule'
    steps:
      - uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            
            const caches = await github.rest.actions.getActionsCacheList({
              owner,
              repo,
              per_page: 100
            });
            
            const thirtyDaysAgo = new Date();
            thirtyDaysAgo.setDate(thirtyDaysAgo.getDate() - 30);
            
            let deletedCount = 0;
            for (const cache of caches.data.actions_caches) {
              const lastAccessed = new Date(cache.last_accessed_at);
              if (lastAccessed < thirtyDaysAgo) {
                await github.rest.actions.deleteActionsCacheById({
                  owner,
                  repo,
                  cache_id: cache.id
                });
                deletedCount++;
                console.log(`Deleted cache: ${cache.key}`);
              }
            }
            
            console.log(`Deleted ${deletedCount} old caches`);

  # Clean up old workflow run artifacts
  artifact-cleanup:
    name: Artifact Cleanup
    runs-on: ubuntu-latest
    if: github.event.inputs.task == 'all' || github.event.inputs.task == 'artifact-cleanup' || github.event_name == 'schedule'
    steps:
      - uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            
            const artifacts = await github.rest.actions.listArtifactsForRepo({
              owner,
              repo,
              per_page: 100
            });
            
            const sevenDaysAgo = new Date();
            sevenDaysAgo.setDate(sevenDaysAgo.getDate() - 7);
            
            let deletedCount = 0;
            for (const artifact of artifacts.data.artifacts) {
              const createdAt = new Date(artifact.created_at);
              if (createdAt < sevenDaysAgo) {
                await github.rest.actions.deleteArtifact({
                  owner,
                  repo,
                  artifact_id: artifact.id
                });
                deletedCount++;
                console.log(`Deleted artifact: ${artifact.name}`);
              }
            }
            
            console.log(`Deleted ${deletedCount} old artifacts`);

  # Clean up stale branches
  branch-cleanup:
    name: Branch Cleanup
    runs-on: ubuntu-latest
    if: github.event.inputs.task == 'all' || github.event.inputs.task == 'branch-cleanup' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v6
        with:
          fetch-depth: 0

      - uses: actions/github-script@v8
        with:
          script: |
            const { owner, repo } = context.repo;
            
            const branches = await github.rest.repos.listBranches({
              owner,
              repo,
              per_page: 100
            });
            
            const protectedBranches = ['main', 'master', 'develop', 'staging', 'production'];
            const ninetyDaysAgo = new Date();
            ninetyDaysAgo.setDate(ninetyDaysAgo.getDate() - 90);
            
            for (const branch of branches.data) {
              if (protectedBranches.includes(branch.name)) continue;
              if (branch.protected) continue;
              
              // Get the last commit on the branch
              const commit = await github.rest.repos.getCommit({
                owner,
                repo,
                ref: branch.commit.sha
              });
              
              const commitDate = new Date(commit.data.commit.committer.date);
              
              if (commitDate < ninetyDaysAgo) {
                console.log(`Stale branch: ${branch.name} (last commit: ${commitDate.toISOString()})`);
                // Uncomment to actually delete:
                // await github.rest.git.deleteRef({
                //   owner,
                //   repo,
                //   ref: `heads/${branch.name}`
                // });
              }
            }

  # Check for outdated dependencies
  dependency-check:
    name: Dependency Check
    runs-on: ubuntu-latest
    if: github.event.inputs.task == 'all' || github.event.inputs.task == 'dependency-check' || github.event_name == 'schedule'
    steps:
      - uses: actions/checkout@v6

      - name: Setup Node.js
        uses: actions/setup-node@v6
        with:
          node-version: '20'

      - name: Check npm dependencies
        run: |
          if [ -f package.json ]; then
            echo "## NPM Dependencies" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            npm outdated || true >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true

      - name: Security audit
        run: |
          if [ -f package.json ]; then
            echo "## Security Audit" >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
            npm audit --audit-level=moderate || true >> $GITHUB_STEP_SUMMARY
            echo "\`\`\`" >> $GITHUB_STEP_SUMMARY
          fi
        continue-on-error: true
